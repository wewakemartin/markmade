
/*
Markmade: Draw and illustrate in Obsidian markdown notes.
Authored by Vivek Martin.

If you use and like this plugin, please consider making a donation, 
to support the maintenance and further development of the plugin.
Thank you so much!

Donation Links:
Paypal: https://paypal.me/wewakemartin
Ko-fi: https://ko-fi.com/wewakemartin

*/

var we=Object.defineProperty;var gt=Object.getOwnPropertyDescriptor;var pt=Object.getOwnPropertyNames;var ft=Object.prototype.hasOwnProperty;var ht=(n,e)=>{for(var s in e)we(n,s,{get:e[s],enumerable:!0})},mt=(n,e,s,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of pt(e))!ft.call(n,i)&&i!==s&&we(n,i,{get:()=>e[i],enumerable:!(o=gt(e,i))||o.enumerable});return n};var wt=n=>mt(we({},"__esModule",{value:!0}),n);var kt={};ht(kt,{default:()=>ue});module.exports=wt(kt);var C=require("obsidian");function Y(n,e,s=1){let o=n[n.length-2],i=n[n.length-1];if(e.scale(s,s),n.length>=2){let r=(i.x+o.x)/2,f=(i.y+o.y)/2;o.c&&(e.strokeStyle=o.c),o.w&&(e.lineWidth=o.w*s),o.lineCap&&(e.lineCap=o.lineCap),o.lineJoin&&(e.lineJoin=o.lineJoin),o.blendingMode&&(e.globalCompositeOperation=o.blendingMode),e.quadraticCurveTo(o.x*s,o.y*s,r*s,f*s),e.stroke(),e.beginPath(),e.moveTo(r*s,f*s)}else{let r=n[0];e.strokeStyle=r.c,e.lineWidth=r.w*s,e.lineCap=r.lineCap,e.lineJoin=r.lineJoin,e.globalCompositeOperation=r.blendingMode,e.beginPath(),e.moveTo(r.x*s,r.y*s),e.lineTo((r.x+.1)*s,r.y*s),e.stroke()}}function Te(n,e,s,o,i,r){s.length!==1&&(o.push(s.pop()),n.clearRect(0,0,e.width,e.height),i||(n.fillStyle=r,n.fillRect(0,0,e.width,e.height)),s.slice(1).forEach(f=>{n.beginPath();let u=[];f.forEach(p=>{u.push(p),Y(u,n)})}))}function De(n,e,s,o,i,r){o.length!==0&&(s.push(o.pop()),n.clearRect(0,0,e.width,e.height),i||(n.fillStyle=r,n.fillRect(0,0,e.width,e.height)),s.slice(1).forEach(f=>{n.beginPath();let u=[];f.forEach(p=>{u.push(p),Y(u,n)})}))}function Oe(n,e,s,o,i,r){n.clearRect(0,0,e.width,e.height),i&&o?n.drawImage(o,0,0,e.width,e.height):(n.fillStyle=r,n.fillRect(0,0,e.width,e.height)),s.slice(1).forEach(f=>{n.beginPath();let u=[];f.forEach(p=>{u.push(p),Y(u,n)})})}function Pe(n,e,s,o,i){n.clearRect(0,0,e.width,e.height),s.splice(1),o||(n.fillStyle=i,n.fillRect(0,0,e.width,e.height))}function Ie(n,e,s){let o=s.querySelector(`#${n}`);o&&(o.style.backgroundImage=e)}function ce(n,e,s,o,i,r){let f=r.querySelector(`#${n}`);if(!f)return;let u=`
	  <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='${e}' stroke-width='${s}' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-circle'>
		<circle cx='12' cy='12' r='10'/>
	  </svg>
	`,p=`
	 <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='${o}' stroke='none' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-circle-dot'>
	  <circle cx='12' cy='12' r='${i}'/>
	</svg>
  `,z=encodeURIComponent(u).replace(/'/g,"%27").replace(/"/g,"%22").replace(/#/g,"%23"),T=encodeURIComponent(p).replace(/'/g,"%27").replace(/"/g,"%22").replace(/#/g,"%23"),S=`url("data:image/svg+xml,${z}"),url("data:image/svg+xml,${T}")`;f.style.backgroundImage=S}var de=async(n,e,s,o,i,r,f,u,p)=>{let S=`.obsidian/plugins/markmade-plugin/Backup/${`${n}_${e.id}.json`}`;if(!await p.vault.adapter.exists(S)){console.log(`File not found: ${S}`);return}let R=await p.vault.adapter.read(S),E=JSON.parse(R);if(u.isSourceMode&&i&&(i.length=0,console.log("Stroke History Cleared. Source Mode: "+u.isSourceMode)),s.clearRect(0,0,e.width,e.height),E.length>0&&E[0].length>0){let{ID:w,Width:O,Height:P,DisplayWidth:h,BgImgData:b,Modified:k}=E[0][0];e.width=O,e.height=P;let I=window.moment(w,"x").fromNow(),F=window.moment(k,"x").fromNow();o?e.style.width=`${o}px`:e.style.width=`${h}px`,b&&(r.src=b,e.style.backgroundImage=`url('${b}')`,f.bgImgDataUrl=b,u.isBgImg=!0),console.log("Loaded Data :"+O,P,"BG: "+u.isBgImg,"Created: "+I,"Modified: "+F)}u.isBgImg||(s.fillStyle=f.fillColor,s.fillRect(0,0,e.width,e.height)),E.map(function(w,O){if(u.isSourceMode&&i&&i.push(w),O===0)return;s.beginPath();let P=[];w.map(function(h){P.push(h),Y(P,s,1)})}),console.log("Strokes Drawn: "+(E.length-1),"Source Mode: "+u.isSourceMode)};var ve=async(n,e,s,o,i)=>{if(!o.isSourceMode||n.length<1)return;let r=`${e}_${s.id}.json`,f=".obsidian/plugins/markmade-plugin/Backup",u=`${f}/${r}`,p=JSON.stringify(n);await i.vault.adapter.exists(f)||await i.vault.createFolder(f),await i.vault.adapter.write(u,p),console.log("Stroke history saved. Source Mode:",o.isSourceMode),o.isNewStrokes=!1};var $e=require("obsidian"),Fe=async(n,e,s,o,i)=>{let r=`${s}${n}_${e.id}${o}`,p=`.obsidian/plugins/markmade-plugin/Backup/${`${n}_${e.id}.json`}`;await i.vault.adapter.exists(p)?(await i.vault.adapter.remove(p),console.log(`Canvas image deleted from ${p}`)):console.log(`File not found: ${p}`);let T=i.workspace.getActiveViewOfType($e.MarkdownView);if(T){let S=T.editor,m=S.getValue();if(m.indexOf(r)!==-1){let E=m.replace(r,`
`);S.setValue(E),console.log("Code block cleared from the document.")}else console.log("Code block not found in the document.")}else console.log("No active Markdown view found. Please open a Markdown file.")};var xe=require("obsidian"),Ne=async(n,e,s,o,i,r,f,u,p)=>{let z=`${f}${e}_${n.id}${u}`,S=n.toDataURL("image/jpeg",1).replace(/^data:image\/jpeg;base64,/,""),m=Uint8Array.from(atob(S),I=>I.charCodeAt(0)).buffer,R=window.moment(o,"x").format(i),E=`${s}_${R}.jpeg`,w=`${r}/${E}`,h=`.obsidian/plugins/markmade-plugin/Backup/${`${e}_${n.id}.json`}`;await p.vault.adapter.exists(w)?(console.log(`File already exists at ${w}`),await p.vault.adapter.writeBinary(w,m),console.log(`Canvas replaced to ${w}`)):(await p.vault.createBinary(w,m),console.log(`Canvas saved to ${w}`));let k=p.workspace.getActiveViewOfType(xe.MarkdownView);if(k){let I=k.editor,F=`![[${E}]]
`,x=I.getValue();x.indexOf(z)!==-1?(I.setValue(x.replace(z,F)),console.log("Drawing Embedded"),await p.vault.adapter.exists(h)?(await p.vault.adapter.remove(h),console.log(`Canvas JSON deleted from ${h}`)):console.log(`File not found: ${h}`)):console.log("Code block not found in the document.")}else console.log("No active Markdown view found. Please open a Markdown file.")};var He=(n,e,s,o,i)=>{let r=n.ownerDocument.createElement("input");return r.type="file",r.accept="image/jpeg, image/png, image/webp, image/svg+xml",r.style.display="none",r.addEventListener("change",f=>{let u=f.target.files[0];if(u){if(!["image/jpeg","image/png","image/webp","image/svg+xml"].includes(u.type)){console.error("Invalid file type selected:",u.type);return}console.log("Valid file type:",u.type),vt(u,e,s,o,i)}else console.log("User canceled file selection.")}),r};function vt(n,e,s,o,i){let r=new FileReader;r.onload=f=>{let u=new Image;u.onload=()=>{e.height=e.width*(u.naturalHeight/u.naturalWidth);let p=f.target.result;e.style.backgroundImage=`url('${p}')`,i.isSourceMode&&(s.src=p,i.isBgImg=!0,i.isNewStrokes=!0,o.splice(1),o[0][0].Width=e.width,o[0][0].Height=e.height,o[0][0].BgImgData=p,console.log(`strokeHistory Updated. SourceMode: ${i.isSourceMode}`))},u.src=f.target.result},r.readAsDataURL(n)}function ze(n,e){let s=n.createEl("canvas",{cls:"drawing-board",attr:{id:e}}),o=s.getContext("2d");return{cnv:s,ctx:o}}function Re(n){let e=n.createEl("div",{cls:"dock-panel"}),s=e.createEl("div",{cls:"tools-panel"}),o=e.createEl("div",{cls:"palette-panel"}),i=e.createEl("div",{cls:"options-panel"}),r=s.createEl("div",{cls:"toolSize-panel"}),f=s.createEl("div",{cls:"toolOpacity-panel"}),u=s.createEl("div",{cls:"toolType-panel"}),p=e.createEl("button",{cls:"dockBtns1",attr:{id:"undo"}}),z=e.createEl("button",{cls:"dockBtns1",attr:{id:"redo"}}),T=e.createEl("button",{cls:"dockBtns2",attr:{id:"tools"}}),S=e.createEl("button",{cls:"dockBtns2",attr:{id:"palette"}}),m=e.createEl("button",{cls:"dockBtns2",attr:{id:"options"}}),R=r.createEl("button",{cls:"toolSizeBtns",attr:{id:"xsStroke"}}),E=r.createEl("button",{cls:"toolSizeBtns",attr:{id:"sStroke"}}),w=r.createEl("button",{cls:"toolSizeBtns",attr:{id:"mStroke"}}),O=r.createEl("button",{cls:"toolSizeBtns",attr:{id:"lStroke"}}),P=r.createEl("button",{cls:"toolSizeBtns",attr:{id:"xlStroke"}});w.classList.toggle("button-selected");let h=u.createEl("button",{cls:"toolTypeBtns",attr:{id:"marker"}});h.dataset.lineCap="round",h.dataset.lineJoin="bevel",h.dataset.opacity="1",h.dataset.blendMode="source-over",h.dataset.xsStroke="0.15",h.dataset.sStroke="0.25",h.dataset.mStroke="0.45",h.dataset.lStroke="0.65",h.dataset.xlStroke="0.85";let b=u.createEl("button",{cls:"toolTypeBtns",attr:{id:"highlighter"}});b.dataset.lineJoin="miter",b.dataset.lineCap="butt",b.dataset.opacity="0.8",b.dataset.blendMode="source-over",b.dataset.xsStroke="0.35",b.dataset.sStroke="0.55",b.dataset.mStroke="0.85",b.dataset.lStroke="1.25",b.dataset.xlStroke="1.5";let k=u.createEl("button",{cls:"toolTypeBtns",attr:{id:"eraser"}});k.dataset.lineCap="round",k.dataset.lineJoin="bevel",k.dataset.opacity="1",k.dataset.blendMode="destination-out",k.dataset.xsStroke="0.35",k.dataset.sStroke="0.55",k.dataset.mStroke="1",k.dataset.lStroke="1.25",k.dataset.xlStroke="1.5",h.classList.toggle("button-selected");let I=o.createEl("button",{cls:"colorBtns",attr:{id:"color1"}}),F=o.createEl("button",{cls:"colorBtns",attr:{id:"color2"}}),x=o.createEl("button",{cls:"colorBtns",attr:{id:"color3"}}),N=o.createEl("button",{cls:"colorBtns",attr:{id:"color4"}}),D=o.createEl("button",{cls:"colorBtns",attr:{id:"color5"}}),V=o.createEl("button",{cls:"colorBtns",attr:{id:"color6"}}),j=o.createEl("button",{cls:"colorBtns",attr:{id:"color7"}}),q=o.createEl("button",{cls:"colorBtns",attr:{id:"color8"}}),G=o.createEl("button",{cls:"colorBtns",attr:{id:"color9"}}),M=o.createEl("button",{cls:"colorBtns",attr:{id:"color10"}});I.dataset.defaultcolor="#dc143c",F.dataset.defaultcolor="#ff8c00",x.dataset.defaultcolor="#ffd700",N.dataset.defaultcolor="#228b22",D.dataset.defaultcolor="#4169e1",V.dataset.defaultcolor="#663399",j.dataset.defaultcolor="#ff69b4",q.dataset.defaultcolor="#00ced1",G.dataset.defaultcolor="#ffffff",M.dataset.defaultcolor="#000000",I.classList.toggle("button-selected");let l=i.createEl("button",{cls:"optionBtns",attr:{id:"option1"}}),B=i.createEl("button",{cls:"optionBtns",attr:{id:"option2"}}),$=i.createEl("button",{cls:"optionBtns",attr:{id:"option3"}}),J=i.createEl("button",{cls:"optionBtns",attr:{id:"option4"}}),A=i.createEl("button",{cls:"optionBtns",attr:{id:"option5"}});return $.classList.add("option3-btn-horizontal"),{dockPanel:e,toolsPanel:s,palettePanel:o,optionsPanel:i,toolSizePanel:r,toolOpacityPanel:f,toolTypePanel:u,undoBtn:p,redoBtn:z,toolsBtn:T,paletteBtn:S,optionsBtn:m,xsStrokeBtn:R,sStrokeBtn:E,mStrokeBtn:w,lStrokeBtn:O,xlStrokeBtn:P,markerBtn:h,highlighterBtn:b,eraserBtn:k,color1:I,color2:F,color3:x,color4:N,color5:D,color6:V,color7:j,color8:q,color9:G,color10:M,option1:l,option2:B,option3:$,option4:J,option5:A}}var bt={timeFormat:"",defaultFolder:"",prefixName:"",imageQuality:"low"},be=class extends C.PluginSettingTab{constructor(s,o){super(s,o);this.plugin=o}display(){let{containerEl:s}=this;s.empty(),new C.Setting(s).setName("Default Folder Path").setDesc("Images created using Markmade will be saved in this folder").addText(o=>o.setPlaceholder("Folder1/Folder2").setValue(this.plugin.settings.defaultFolder).onChange(async i=>{this.plugin.settings.defaultFolder=i,await this.plugin.saveSettings()})),new C.Setting(s).setName("File Name").setDesc("Images will be saved with this as the first prefix").addText(o=>o.setPlaceholder("Markmade").setValue(this.plugin.settings.prefixName).onChange(async i=>{this.plugin.settings.prefixName=i,await this.plugin.saveSettings()})),new C.Setting(s).setName("Time Stamp").setDesc("Images will be saved with this as the second prefix").addText(o=>o.setPlaceholder("YYYYMMDDHHmmss").setValue(this.plugin.settings.timeFormat).onChange(async i=>{this.plugin.settings.timeFormat=i,await this.plugin.saveSettings()})),new C.Setting(s).setName("Image Quality").setDesc("Select the quality of the image (affects resolution and performance)").addDropdown(o=>o.addOption("low","Good").addOption("medium","Better").addOption("high","Best").setValue(this.plugin.settings.imageQuality||"low").onChange(async i=>{this.plugin.settings.imageQuality=i,await this.plugin.saveSettings()}))}},ue=class extends C.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new be(this.app,this));let s="Markmade",o="```mark-made\n\n// ![[",i="]]\n\n```\n",r={a:10/16,b:16/10,c:1},f={landscape:800,portrait:500},u={low:1.25,medium:2,high:3.25},p=!0,z=this.app.vault.getConfig("enabledRTL"),T,S=!1,m,R=this.app.vault.getConfig("attachmentFolderPath"),E=s,w="YYYYMMDDHHmmss",O=u.low;async function P(){this.settings.defaultFolder?await this.app.vault.adapter.exists(`${this.settings.defaultFolder}`)&&(R=this.settings.defaultFolder):console.log("Folder Undefined"),this.settings.prefixName?E=this.settings.prefixName:console.log("Prefix Name Undefined"),this.settings.timeFormat?w=this.settings.timeFormat:console.log("Time Format Undefined"),this.settings.imageQuality?O=u[this.settings.imageQuality]:console.log("Image Quality Undefined"),p&&console.log("Folder: "+R,"File Name: "+E+"_"+w,"Quality: "+O)}P.call(this);function h(){let N=setInterval(()=>{let D=document.querySelector(".cm-sizer");D?(m=D.clientWidth,console.log(m),clearInterval(N)):p&&console.log("Markdown editor not found, retrying...")},1e3)}h();let b=this.addRibbonIcon("file-image","Create new drawing",N=>{let D=this.app.workspace.getActiveViewOfType(C.MarkdownView);if(D)if(D.getMode()==="source"){P.call(this);let j=D.editor,q=window.moment().format("x"),G=`${o}${s}_${q}${i}`;S=!0,j.replaceSelection(G),j.scrollIntoView({from:j.getCursor(),to:j.getCursor()}),p&&console.log("A new drawing has been created!")}else new C.Notice("Please switch to Source Mode to create a new drawing.");else new C.Notice("Please open a Markdown file to create a new drawing.")}),k=window.screen.width,I=window.screen.height,F=window.devicePixelRatio,x=window.screen.orientation.type;console.log(`Screen Width: ${k}`),console.log(`Screen Height: ${I}`),console.log(`Pixel Density: ${F}`),console.log(`Screen Orientation: ${x}`),window.addEventListener("resize",()=>{h()}),window.screen.orientation.addEventListener("change",()=>{h()}),this.registerMarkdownCodeBlockProcessor("mark-made",(N,D)=>{let V,j=new RegExp(`!\\[\\[${s}_(\\d+)\\]\\]`),q=N.match(j);q&&(V=q[1]);let G=`markmade_${V}`,M=D.createEl("div",{cls:"markmade",attr:{id:G}}),{cnv:l,ctx:B}=ze(M,V);l.style.width=`${m}px`;let{dockPanel:$,toolsPanel:J,palettePanel:A,optionsPanel:X,toolSizePanel:je,toolOpacityPanel:Ue,toolTypePanel:Ve,toolsBtn:K,paletteBtn:W,optionsBtn:Q,option3:ke}=Re(M),d={isHorizontal:!0,isDockOpen:!0,isToolsOpen:!1,isPaletteOpen:!1,isOptionsOpen:!1},g={isActive:!1,isDrawing:!1,isNewStrokes:!1,isBgImg:!1},c={lineCap:"round",lineJoin:"bevel",tipWidth:.45*F,tipPush:0,strokeOpacity:1,globalOpacity:1,strokeColor:"#dc143c",fillColor:"#FFFEF5",blendingMode:"source-over",toolSize:"mStroke",toolType:"marker",toolColor:"color1",bgImgDataUrl:void 0},oe=new Image,ye,_=[],ie=[],y=[],H;function Je(){H=l.width/m}let Ae=()=>{let t=this.app.workspace.getActiveViewOfType(C.MarkdownView);t&&(t.getMode()==="source"?(g.isSourceMode=!0,console.log("SourceMode: "+g.isSourceMode)):(g.isSourceMode=!1,console.log("ID: "+l.id+", SourceMode: "+g.isSourceMode,", StrokeHistory:"+(y.length-1)),g.isCodeBlock&&g.isSourceMode===!1&&de(s,l,B,m,y,oe,c,g,this.app)))};this.registerEvent(this.app.workspace.on("layout-change",Ae));function We(t){let a=t.target;a&&T!==l&&(Ce(l),Me(),console.log(T.id)),a&&a.id==="undo"&&Ye(),a&&a.id==="redo"&&qe(),a&&a.id==="tools"&&Qe(),a&&a.id==="palette"&&Ge(),a&&a.id==="options"&&Xe(),a&&a.id==="option1"&&Ke.call(this),a&&a.id==="option2"&&Ze(),a&&a.id==="option3"&&he(),a&&a.id==="option4"&&et(),a&&a.id==="option5"&&tt.call(this),a&&a.classList.contains("toolTypeBtns")&&st(a),a&&a.classList.contains("toolSizeBtns")&&ot(a),a&&a.classList.contains("colorBtns")&&nt(a),t.stopPropagation()}let Se=We.bind(this);function _e(){M.addEventListener("click",Se)}function Ee(){M.removeEventListener("click",Se),p&&console.log("Markmade container event listener removed.")}let ge;function le(t){if(t instanceof TouchEvent&&t.touches&&t.touches.length>=2)return;t.preventDefault();let a=.1,v,L;Je();let U=l.getBoundingClientRect().left,ee=l.getBoundingClientRect().top;t instanceof TouchEvent&&t.touches&&t.touches[0]&&typeof t.touches[0].force!="undefined"?(t.touches[0].force>0&&(a=t.touches[0].force),v=(t.touches[0].clientX-U)*H,L=(t.touches[0].clientY-ee)*H):t instanceof MouseEvent&&(a=1,v=t.offsetX*H,L=t.offsetY*H),g.isDrawing=!0,re(),c.tipPush=Math.log(a+1)*40;let te=Math.round(c.tipPush*c.tipWidth*H*10)/10;v=Math.round(v*10)/10,L=Math.round(L*10)/10,ge=`rgba(${parseInt(c.strokeColor.slice(1,3),16)},${parseInt(c.strokeColor.slice(3,5),16)},${parseInt(c.strokeColor.slice(5,7),16)},${c.strokeOpacity})`;let ct=c.lineCap,dt=c.lineJoin,ut=c.blendingMode;_.push({x:v,y:L,w:te,c:ge,lineCap:ct,lineJoin:dt,blendingMode:ut}),Y(_,B,1)}function se(t){if(!g.isDrawing||t instanceof TouchEvent&&t.touches&&t.touches.length>=2)return;t.preventDefault();let a=.1,v,L,U=l.getBoundingClientRect().left,ee=l.getBoundingClientRect().top;t instanceof TouchEvent&&t.touches&&t.touches[0]&&typeof t.touches[0].force!="undefined"?(t.touches[0].force>0&&(a=t.touches[0].force),v=(t.touches[0].clientX-U)*H,L=(t.touches[0].clientY-ee)*H):t instanceof MouseEvent&&(a=1,v=t.offsetX*H,L=t.offsetY*H),c.tipPush=Math.log(a+1)*40*.2+c.tipPush*.8;let te=Math.round(c.tipPush*c.tipWidth*H*10)/10;v=Math.round(v*10)/10,L=Math.round(L*10)/10,_.push({x:v,y:L,w:te,c:ge}),Y(_,B,1)}let yt=it(se,90);function ae(t){g.isDrawing&&(t instanceof TouchEvent&&t.touches&&t.touches.length>=2||(console.log("canvas mouse is up"),g.isDrawing=!1,c.tipPush=0,fe(),lt(function(){y[0][0].Modified=window.moment().format("x"),y.push([..._]),_=[],ie=[],g.isNewStrokes=!0})))}function Le(t){if(!g.isDrawing||t instanceof TouchEvent&&t.touches&&t.touches.length>=2)return;y.push([..._]),_=[],ie=[],t.preventDefault();let a=function(){console.log("Window mouse is up"),c.tipPush=0,window.removeEventListener("mouseup",a),g.isDrawing&&(fe(),g.isDrawing=!1)};window.addEventListener("mouseup",a)}function Ce(t){t&&(t.addEventListener("mousedown",le,{passive:!1}),t.addEventListener("touchstart",le,{passive:!1}),t.addEventListener("mousemove",se,{passive:!1}),t.addEventListener("touchmove",se,{passive:!1}),t.addEventListener("mouseup",ae,{passive:!1}),t.addEventListener("touchend",ae,{passive:!1}),t.addEventListener("mouseleave",Le,{passive:!1}),T=t,console.log("Event Listeners added. Canvas ID: "+t.id))}function pe(t){t&&(t.removeEventListener("mousedown",le),t.removeEventListener("touchstart",le),t.removeEventListener("mousemove",se),t.removeEventListener("touchmove",se),t.removeEventListener("mouseup",ae),t.removeEventListener("touchend",ae),t.removeEventListener("mouseleave",Le),console.log("Event Listeners removed. Canvas ID: "+t.id))}function Ye(){Z(),Te(B,l,y,ie,g.isBgImg,c.fillColor),g.isNewStrokes=!0}function qe(){Z(),De(B,l,y,ie,g.isBgImg,c.fillColor),g.isNewStrokes=!0}function Qe(){d.isPaletteOpen&&(A.classList.toggle("show-panel"),W.classList.toggle("button-selected"),d.isPaletteOpen=!1),d.isOptionsOpen&&(X.classList.toggle("show-panel"),Q.classList.toggle("button-selected"),d.isOptionsOpen=!1),d.isToolsOpen?(J.classList.toggle("show-panel"),K.classList.toggle("button-selected"),d.isToolsOpen=!1):(J.classList.toggle("show-panel"),K.classList.toggle("button-selected"),d.isToolsOpen=!0)}function Ge(){d.isToolsOpen&&(J.classList.toggle("show-panel"),K.classList.toggle("button-selected"),d.isToolsOpen=!1),d.isOptionsOpen&&(X.classList.toggle("show-panel"),Q.classList.toggle("button-selected"),d.isOptionsOpen=!1),d.isPaletteOpen?(A.classList.toggle("show-panel"),W.classList.toggle("button-selected"),d.isPaletteOpen=!1):(A.classList.toggle("show-panel"),W.classList.toggle("button-selected"),d.isPaletteOpen=!0)}function Xe(){d.isToolsOpen&&(J.classList.toggle("show-panel"),K.classList.toggle("button-selected"),d.isToolsOpen=!1),d.isPaletteOpen&&(A.classList.toggle("show-panel"),W.classList.toggle("button-selected"),d.isPaletteOpen=!1),d.isOptionsOpen?(X.classList.toggle("show-panel"),Q.classList.toggle("button-selected"),d.isOptionsOpen=!1):(X.classList.toggle("show-panel"),Q.classList.toggle("button-selected"),d.isOptionsOpen=!0)}function Ke(){re(),l.classList.remove("reveal-drawing-board"),l.classList.remove("show-drawing-board"),me(),Ee(),pe(l),setTimeout(async()=>{await Fe(s,l,o,i,this.app),g.isCodeBlock=!1},550)}function Ze(){Z(),Pe(B,l,y,g.isBgImg,c.fillColor),g.isNewStrokes=!0}function et(){Z(),ye.click(),y[0][0].BgImgData&&(c.bgImgDataUrl=y[0][0].BgImgData)}async function tt(){re(),me(),Ee(),pe(l),await P.call(this),Oe(B,l,y,oe,g.isBgImg,c.fillColor),setTimeout(async()=>{await Ne(l,s,E,V,w,R,o,i,this.app),g.isCodeBlock=!1},350)}function re(){d.isDockOpen&&(Z(),d.isHorizontal?$.classList.toggle("show-bottom-dock-panel"):$.classList.toggle("show-side-dock-panel"),d.isDockOpen=!1)}function fe(){d.isDockOpen||(d.isHorizontal?$.classList.toggle("show-bottom-dock-panel"):$.classList.toggle("show-side-dock-panel"),d.isDockOpen=!0)}function Z(){d.isToolsOpen&&(J.classList.toggle("show-panel"),K.classList.toggle("button-selected"),d.isToolsOpen=!1),d.isPaletteOpen&&(A.classList.toggle("show-panel"),W.classList.toggle("button-selected"),d.isPaletteOpen=!1),d.isOptionsOpen&&(X.classList.toggle("show-panel"),Q.classList.toggle("button-selected"),d.isOptionsOpen=!1)}function he(){re(),setTimeout(()=>{Q.classList.remove("button-selected"),$.classList.toggle("dock-panel-vertical"),J.classList.toggle("tools-panel-vertical"),je.classList.toggle("toolSize-panel-vertical"),Ve.classList.toggle("toolType-panel-vertical"),Ue.classList.toggle("toolOpacity-panel-vertical"),A.classList.toggle("palette-panel-vertical"),X.classList.toggle("options-panel-vertical"),K.classList.toggle("tools-btn-vertical"),W.classList.toggle("palette-btn-vertical"),Q.classList.toggle("options-btn-vertical"),ke.classList.toggle("option3-btn-vertical"),ke.classList.toggle("option3-btn-horizontal"),d.isHorizontal?d.isHorizontal=!1:d.isHorizontal=!0,fe()},300)}function ot(t){c.toolSize&&M.querySelector(`#${c.toolSize}`).classList.remove("button-selected"),t.classList.toggle("button-selected");let a=t.id,v=M.querySelector(`#${c.toolType}`);c.tipWidth=parseFloat(v.dataset[a]||"0.5")*F,c.toolSize=t.id}function st(t){c.toolType&&M.querySelector(`#${c.toolType}`).classList.remove("button-selected"),t.classList.toggle("button-selected");let a=getComputedStyle(t).backgroundImage;Ie("tools",a,M);let v=c.toolSize;c.tipWidth=parseFloat(t.dataset[v]||"0.45")*F,c.lineCap=t.dataset.lineCap||"round",c.lineJoin=t.dataset.lineJoin||"bevel",c.strokeOpacity=parseFloat(t.dataset.opacity||"1"),c.blendingMode=t.dataset.blendMode||"source-over",c.toolType=t.id}function nt(t){if(c.toolColor){let a=M.querySelector(`#${c.toolColor}`);a.classList.remove("button-selected"),ce(c.toolColor,"white","2",a.dataset.defaultcolor,"8",M)}t.classList.toggle("button-selected"),c.strokeColor=t.dataset.defaultcolor||"#dc143c",ce(t.id,t.dataset.defaultcolor,"2.25",t.dataset.defaultcolor,"6",M),ce("palette","white","2",t.dataset.defaultcolor,"7",M),c.toolColor=t.id}function it(t,a=60){let v=1e3/a,L,U;return function(...ee){let te=this;U?(clearTimeout(L),L=setTimeout(function(){Date.now()-U>=v&&(t.apply(te,ee),U=Date.now())},v-(Date.now()-U))):(t.apply(te,ee),U=Date.now())}}let lt=window.requestIdleCallback||function(t){setTimeout(t,1)},ne=null,Me=()=>{ne=setInterval(async()=>{g.isNewStrokes&&(W.classList.toggle("save-indicator"),await ve(y,s,l,g,this.app),console.log("Canvas auto-saved."),setTimeout(()=>{W.classList.toggle("save-indicator")},650)),!(!g.isNewStrokes&&T===l)&&!g.isNewStrokes&&T!==l&&(Z(),me(),pe(l))},15e3),this.registerInterval(ne)},me=()=>{ne&&(clearInterval(ne),ne=null,console.log("Autosave stopped. Canvas ID: "+l.id))},Be=this.app.workspace.getActiveViewOfType(C.MarkdownView);Be&&(Be.getMode()==="source"?(g.isSourceMode=!0,_e(),S&&m?(l.width=m,x==="landscape-primary"||x==="landscape-secondary"?(l.width=f.landscape*O,console.log(l.width),l.height=l.width*r.a,B.fillStyle=c.fillColor,B.fillRect(0,0,l.width,l.height),setTimeout(()=>{d.isHorizontal=!0,l.classList.toggle("reveal-drawing-board"),$.classList.toggle("show-bottom-dock-panel"),d.isDockOpen=!0},100)):(l.width=f.portrait*O,l.height=l.width*r.b,B.fillStyle=c.fillColor,B.fillRect(0,0,l.width,l.height),setTimeout(()=>{d.isHorizontal=!0,l.classList.toggle("reveal-drawing-board"),$.classList.toggle("show-bottom-dock-panel"),d.isDockOpen=!0,he()},100)),y.push([{ID:l.id,Width:l.width,Height:l.height,DisplayWidth:m,BgImgData:"",Modified:""}]),g.isNewStrokes=!0,ve(y,s,l,g,this.app),S=!1,g.isCodeBlock=!0,Ce(l),Me()):(de(s,l,B,m,y,oe,c,g,this.app),x==="landscape-primary"||x==="landscape-secondary"?(d.isHorizontal=!0,l.classList.toggle("reveal-drawing-board"),$.classList.toggle("show-bottom-dock-panel"),d.isDockOpen=!0):(d.isHorizontal=!0,l.classList.toggle("reveal-drawing-board"),$.classList.toggle("show-bottom-dock-panel"),d.isDockOpen=!0,he()),g.isNewStrokes=!1,g.isCodeBlock=!0),ye=He(D,l,oe,y,g)):(g.isSourceMode=!1,de(s,l,B,m,y,oe,c,g,this.app),l.classList.add("show-inert-board"),g.isNewStrokes=!1,g.isCodeBlock=!0));let at=async function(){}.constructor,rt=new at("cnv","src",`return (async () => { ${N} })()`);setTimeout(()=>rt(l,N),200)})}onunload(){}async loadSettings(){this.settings=Object.assign({},bt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
